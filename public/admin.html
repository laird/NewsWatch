<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsWatch Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Roboto:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 48px;
            font-weight: 900;
            letter-spacing: -1px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input[type="password"],
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 300px;
            font-family: 'Roboto Mono', monospace;
            line-height: 1.6;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Roboto', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(22, 163, 74, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .status-success {
            background: #ecfdf5;
            border: 1px solid #16a34a;
            color: #16a34a;
        }

        .status-error {
            background: #fef2f2;
            border: 1px solid #dc2626;
            color: #dc2626;
        }

        .status-info {
            background: #f0f4ff;
            border: 1px solid #667eea;
            color: #667eea;
        }

        .meta-info {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        .char-counter {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }

        .log-viewer {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            min-height: 400px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-file-list {
            list-style: none;
            margin: 15px 0;
        }

        .log-file-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .log-file-item:hover {
            background: #f5f5f5;
        }

        .log-file-item.active {
            background: #e8eaf6;
            font-weight: 600;
        }

        .log-file-name {
            font-weight: 500;
        }

        .log-file-meta {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        table th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            border-bottom: 2px solid #1a1a1a;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .archive-list {
            list-style: none;
        }

        .archive-item {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-test {
            background: #fef2f2;
            color: #dc2626;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>NewsWatch</h1>
            <p>Admin Panel</p>
        </div>

        <!-- Authentication Section -->
        <div id="auth-card" class="card auth-section" style="text-align: center;">
            <h2>üîê Authentication Required</h2>
            <div class="form-group">
                <input type="password" id="auth-password" placeholder="Enter admin password"
                    onkeypress="handleAuthKeypress(event)">
            </div>
            <button class="btn btn-primary" onclick="authenticate()">Unlock Admin Panel</button>
            <div id="auth-status"></div>
        </div>

        <!-- Main Admin Panel (hidden until authenticated) -->
        <div id="admin-panel" class="hidden">
            <div class="card">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('guidance')">ü§ñ Guidance</button>
                    <button class="tab" onclick="switchTab('analytics')">üìä Analytics</button>
                    <button class="tab" onclick="switchTab('logs')">üìã Logs</button>
                    <button class="tab" onclick="switchTab('users')">üë• Users</button>
                </div>

                <!-- Guidance Tab -->
                <div id="tab-guidance" class="tab-content active">
                    <h2 style="margin-bottom: 20px;">AI Guidance Editor</h2>
                    <div class="form-group">
                        <label for="guidance-text">Current AI Instructions:</label>
                        <textarea id="guidance-text" placeholder="Loading guidance..."></textarea>
                        <div class="char-counter">
                            <span id="char-count">0</span> characters
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveGuidance()">üíæ Save Guidance</button>
                    <div id="guidance-status"></div>
                    <div class="meta-info" id="guidance-meta"></div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

                    <h3 style="margin-bottom: 15px; font-size: 18px;">Newsletter Testing</h3>
                    <p style="margin-bottom: 15px; color: #666;">
                        Generate and send a test newsletter to all test users with the current guidance included.
                    </p>
                    <button class="btn btn-success" id="trigger-btn" onclick="triggerNewsletter()">
                        ‚ö° Generate & Send Test Newsletter
                    </button>
                    <div id="newsletter-status"></div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

                    <h3 style="margin-bottom: 15px; font-size: 18px;">Check Email Feedback</h3>
                    <p style="margin-bottom: 15px; color: #666;">
                        Manually check for new email replies and process user feedback.
                    </p>
                    <button class="btn btn-primary" id="check-feedback-btn" onclick="checkFeedback()">
                        üì® Check for New Feedback
                    </button>
                    <div id="feedback-status"></div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

                    <h3 style="margin-bottom: 15px; font-size: 18px;">Clean Up Duplicate Sources</h3>
                    <p style="margin-bottom: 15px; color: #666;">
                        Run the cleanup script to remove duplicate source URLs from merged stories in the database.
                    </p>
                    <button class="btn btn-primary" id="cleanup-btn" onclick="runCleanup()">
                        üßπ Run Cleanup
                    </button>
                    <div id="cleanup-status"></div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

                    <h3 style="margin-bottom: 15px; font-size: 18px;">Recent Newsletter Archives</h3>
                    <ul class="archive-list" id="archive-list">
                        <li style="text-align: center; color: #999;">Loading archives...</li>
                    </ul>
                </div>

                <!-- Analytics Tab -->
                <div id="tab-analytics" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Community Voting Report</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        Aggregate voting statistics showing community preferences for sources and categories.
                    </p>

                    <h3 style="font-size: 18px; margin-bottom: 15px;">Source Preferences</h3>
                    <div style="overflow-x: auto; margin-bottom: 30px;">
                        <table id="sources-table">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th style="text-align: center;">Net Votes</th>
                                    <th style="text-align: center;">‚Üë</th>
                                    <th style="text-align: center;">‚Üì</th>
                                    <th style="text-align: center;">Stories</th>
                                    <th style="text-align: center;">Multiplier</th>
                                </tr>
                            </thead>
                            <tbody id="sources-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: #999;">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 style="font-size: 18px; margin-bottom: 15px;">Category Preferences</h3>
                    <div style="overflow-x: auto;">
                        <table id="categories-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th style="text-align: center;">Net Votes</th>
                                    <th style="text-align: center;">‚Üë</th>
                                    <th style="text-align: center;">‚Üì</th>
                                    <th style="text-align: center;">Stories</th>
                                    <th style="text-align: center;">Multiplier</th>
                                </tr>
                            </thead>
                            <tbody id="categories-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px; color: #999;">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="voting-report-meta" class="meta-info" style="margin-top: 15px;"></div>
                </div>

                <!-- Logs Tab -->
                <div id="tab-logs" class="tab-content">
                    <h2 style="margin-bottom: 20px;">Server Logs</h2>

                    <div class="form-group">
                        <label for="log-file-select">Select Log File:</label>
                        <select id="log-file-select" onchange="loadLogFile()">
                            <option value="">Loading log files...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="log-lines">Number of lines to display:</label>
                        <input type="number" id="log-lines" value="100" min="10" max="10000" style="width: 150px;">
                        <button class="btn btn-primary" style="margin-left: 10px;" onclick="loadLogFile()">üì• Refresh
                        </button>
                    </div>

                    <div class="meta-info" id="log-meta"></div>

                    <div class="log-viewer" id="log-content">Select a log file to view its contents...</div>
                </div>

                <!-- Users Tab -->
                <div id="tab-users" class="tab-content">
                    <h2 style="margin-bottom: 20px;">User Management</h2>

                    <!-- Add New User Form -->
                    <div class="card" style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; font-size: 18px;">Add New User</h3>
                        <div class="form-group">
                            <label for="new-user-email">Email Address:</label>
                            <input type="email" id="new-user-email" placeholder="user@example.com"
                                style="margin-bottom: 10px;">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="new-user-test" checked>
                                <span>Test User (receives AI guidance in newsletters)</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="new-user-subscribed" checked>
                                <span>Subscribed</span>
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="createUser()">‚ûï Add User</button>
                        <div id="add-user-status"></div>
                    </div>

                    <!-- Users List -->
                    <div class="card">
                        <h3 style="margin-bottom: 15px; font-size: 18px;">All Users</h3>
                        <div id="users-list">Loading users...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let adminPassword = '';
        let currentTab = 'guidance';

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            currentTab = tabName;

            // Load tab-specific data if needed
            if (tabName === 'logs' && adminPassword) {
                loadLogFileList();
            }
            if (tabName === 'users' && adminPassword) {
                loadUsers();
            }
        }

        function handleAuthKeypress(event) {
            if (event.key === 'Enter') {
                authenticate();
            }
        }

        async function authenticate() {
            const password = document.getElementById('auth-password').value;
            const statusDiv = document.getElementById('auth-status');

            if (!password) {
                showStatus(statusDiv, 'Please enter a password', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.authenticated) {
                    adminPassword = password;
                    document.getElementById('auth-card').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    loadGuidance();
                    loadArchives();
                    loadVotingReport();
                } else {
                    showStatus(statusDiv, '‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, '‚ùå Authentication failed: ' + error.message, 'error');
            }
        }

        async function loadGuidance() {
            const textArea = document.getElementById('guidance-text');
            const statusDiv = document.getElementById('guidance-status');

            try {
                const response = await fetch(`/api/admin/guidance?auth=${encodeURIComponent(adminPassword)}&_=${Date.now()}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                textArea.value = data.guidance || '';
                updateCharCount();

                if (data.lastUpdated) {
                    let lastUpdated;
                    if (data.lastUpdated._seconds) {
                        lastUpdated = new Date(data.lastUpdated._seconds * 1000);
                    } else if (data.lastUpdated.toDate) {
                        lastUpdated = data.lastUpdated.toDate();
                    } else {
                        lastUpdated = new Date(data.lastUpdated);
                    }
                    document.getElementById('guidance-meta').textContent =
                        'Last updated: ' + lastUpdated.toLocaleString();
                } else {
                    document.getElementById('guidance-meta').textContent =
                        'No guidance set yet';
                }

                statusDiv.innerHTML = '';
            } catch (error) {
                console.error('Load guidance error:', error);
                showStatus(statusDiv, '‚ùå Failed to load guidance: ' + error.message, 'error');
                textArea.value = '';
                textArea.placeholder = 'Failed to load guidance. Check console for details.';
            }
        }

        async function saveGuidance() {
            const guidance = document.getElementById('guidance-text').value;
            const statusDiv = document.getElementById('guidance-status');

            if (!guidance.trim()) {
                showStatus(statusDiv, '‚ö†Ô∏è Guidance cannot be empty', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/guidance', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword, guidance })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(statusDiv, '‚úÖ ' + data.message, 'success');
                    setTimeout(() => loadGuidance(), 500);
                } else {
                    showStatus(statusDiv, '‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, '‚ùå Failed to save: ' + error.message, 'error');
            }
        }

        async function triggerNewsletter() {
            const statusDiv = document.getElementById('newsletter-status');
            const btn = document.getElementById('trigger-btn');

            btn.disabled = true;
            showStatus(statusDiv, '‚è≥ Generating newsletter... This may take a minute.', 'info');

            try {
                const response = await fetch('/api/admin/trigger-newsletter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });

                const data = await response.json();

                if (data.success) {
                    const message = `‚úÖ Newsletter sent to ${data.recipientCount} test users with ${data.storyCount} stories. 
                        <a href="${data.archiveUrl}" target="_blank" style="color: #667eea; text-decoration: underline;">View Archive</a>`;
                    showStatus(statusDiv, message, 'success');
                    setTimeout(() => loadArchives(), 1000);
                } else {
                    showStatus(statusDiv, '‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, '‚ùå Failed to generate: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function checkFeedback() {
            const statusDiv = document.getElementById('feedback-status');
            const btn = document.getElementById('check-feedback-btn');

            btn.disabled = true;
            showStatus(statusDiv, '‚è≥ Checking for new feedback...', 'info');

            try {
                const response = await fetch('/api/admin/check-feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(statusDiv, '‚úÖ ' + data.message, 'success');
                } else {
                    showStatus(statusDiv, '‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, '‚ùå Failed to check feedback: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function runCleanup() {
            const statusDiv = document.getElementById('cleanup-status');
            const btn = document.getElementById('cleanup-btn');

            btn.disabled = true;
            showStatus(statusDiv, '‚è≥ Running cleanup script... This may take a moment.', 'info');

            try {
                const response = await fetch('/api/admin/cleanup-duplicates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(statusDiv, '‚úÖ ' + data.message, 'success');
                } else {
                    showStatus(statusDiv, '‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showStatus(statusDiv, '‚ùå Failed to run cleanup: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function loadArchives() {
            try {
                const response = await fetch(`/api/admin/newsletter-archives?auth=${encodeURIComponent(adminPassword)}&limit=10`);
                const data = await response.json();

                const listEl = document.getElementById('archive-list');

                if (data.archives && data.archives.length > 0) {
                    listEl.innerHTML = data.archives.map(archive => {
                        let date;
                        if (archive.date._seconds) {
                            date = new Date(archive.date._seconds * 1000);
                        } else if (archive.date.toDate) {
                            date = archive.date.toDate();
                        } else {
                            date = new Date(archive.date);
                        }
                        const testBadge = archive.isTest ? '<span class="badge badge-test">TEST</span>' : '';
                        return `
                            <li class="archive-item">
                                <div>
                                    <span style="font-weight: 500;">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
                                    ${testBadge}
                                    <span style="font-size: 12px; color: #666; margin-left: 10px;">${archive.recipientCount} recipients ‚Ä¢ ${archive.storyCount} stories</span>
                                </div>
                                <a href="${archive.archiveUrl || '#'}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">View ‚Üí</a>
                            </li>
                        `;
                    }).join('');
                } else {
                    listEl.innerHTML = '<li style="text-align: center; color: #999;">No archives found</li>';
                }
            } catch (error) {
                document.getElementById('archive-list').innerHTML =
                    '<li style="text-align: center; color: #dc2626;">Failed to load archives</li>';
            }
        }

        function updateCharCount() {
            const text = document.getElementById('guidance-text').value;
            document.getElementById('char-count').textContent = text.length;
        }

        function showStatus(element, message, type) {
            element.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        async function loadVotingReport() {
            try {
                const response = await fetch(`/api/admin/voting-report?auth=${encodeURIComponent(adminPassword)}`);
                const data = await response.json();

                // Render sources table
                const sourcesBody = document.getElementById('sources-body');
                if (data.sources && data.sources.length > 0) {
                    sourcesBody.innerHTML = data.sources.map(source => {
                        const netVotes = source.netVotes;
                        const bgColor = netVotes > 0 ? '#ecfdf5' : (netVotes < 0 ? '#fef2f2' : 'white');
                        const isMaxed = source.multiplier === 1.2 || source.multiplier === 0.8;
                        const multStyle = isMaxed ? 'font-weight: 700; color: #dc2626;' : '';

                        return `
                            <tr style="background-color: ${bgColor};">
                                <td style="font-weight: 500;">${source.name}</td>
                                <td style="text-align: center; font-weight: 600; color: ${netVotes > 0 ? '#16a34a' : (netVotes < 0 ? '#dc2626' : '#666')};">${netVotes > 0 ? '+' : ''}${netVotes}</td>
                                <td style="text-align: center;">${source.upvotes}</td>
                                <td style="text-align: center;">${source.downvotes}</td>
                                <td style="text-align: center;">${source.storyCount}</td>
                                <td style="text-align: center; ${multStyle}">${source.multiplier}${isMaxed ? ' (max)' : ''}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    sourcesBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">No voting data yet</td></tr>';
                }

                // Render categories table
                const categoriesBody = document.getElementById('categories-body');
                if (data.categories && data.categories.length > 0) {
                    categoriesBody.innerHTML = data.categories.map(category => {
                        const netVotes = category.netVotes;
                        const bgColor = netVotes > 0 ? '#ecfdf5' : (netVotes < 0 ? '#fef2f2' : 'white');
                        const isMaxed = category.multiplier === 1.2 || category.multiplier === 0.8;
                        const multStyle = isMaxed ? 'font-weight: 700; color: #dc2626;' : '';

                        return `
                            <tr style="background-color: ${bgColor};">
                                <td style="font-weight: 500;">${category.name}</td>
                                <td style="text-align: center; font-weight: 600; color: ${netVotes > 0 ? '#16a34a' : (netVotes < 0 ? '#dc2626' : '#666')};">${netVotes > 0 ? '+' : ''}${netVotes}</td>
                                <td style="text-align: center;">${category.upvotes}</td>
                                <td style="text-align: center;">${category.downvotes}</td>
                                <td style="text-align: center;">${category.storyCount}</td>
                                <td style="text-align: center; ${multStyle}">${category.multiplier}${isMaxed ? ' (max)' : ''}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    categoriesBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">No voting data yet</td></tr>';
                }

                // Update metadata
                const metaDiv = document.getElementById('voting-report-meta');
                if (data.metadata) {
                    const lastUpdated = new Date(data.metadata.lastUpdated);
                    metaDiv.textContent = `Total feedback: ${data.metadata.totalFeedback} ‚Ä¢ Date range: ${data.metadata.dateRange} ‚Ä¢ Last updated: ${lastUpdated.toLocaleString()}`;
                }
            } catch (error) {
                console.error('Failed to load voting report:', error);
                document.getElementById('sources-body').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #dc2626;">Failed to load report</td></tr>';
                document.getElementById('categories-body').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #dc2626;">Failed to load report</td></tr>';
            }
        }

        async function loadLogFileList() {
            try {
                const response = await fetch(`/api/admin/logs?list=true&auth=${encodeURIComponent(adminPassword)}`);
                const data = await response.json();

                const select = document.getElementById('log-file-select');
                if (data.files && data.files.length > 0) {
                    select.innerHTML = '<option value="">-- Select a log file --</option>' +
                        data.files.map(file => {
                            const sizeKb = (file.size / 1024).toFixed(2);
                            const modified = new Date(file.modified).toLocaleString();
                            return `<option value="${file.filename}">${file.filename} (${sizeKb} KB, ${modified})</option>`;
                        }).join('');
                } else {
                    select.innerHTML = '<option value="">No log files found</option>';
                }
            } catch (error) {
                console.error('Failed to load log file list:', error);
                document.getElementById('log-file-select').innerHTML = '<option value="">Error loading files</option>';
            }
        }

        async function loadLogFile() {
            const filename = document.getElementById('log-file-select').value;
            const lines = document.getElementById('log-lines').value;
            const contentDiv = document.getElementById('log-content');
            const metaDiv = document.getElementById('log-meta');

            if (!filename) {
                contentDiv.textContent = 'Please select a log file.';
                metaDiv.textContent = '';
                return;
            }

            contentDiv.textContent = 'Loading...';
            metaDiv.textContent = '';

            try {
                const response = await fetch(`/api/admin/logs?file=${encodeURIComponent(filename)}&lines=${lines}&auth=${encodeURIComponent(adminPassword)}`);
                const data = await response.json();

                if (data.content) {
                    contentDiv.textContent = data.content;
                    metaDiv.textContent = `Showing last ${data.lines} of ${data.totalLines} lines from ${data.filename}`;
                } else {
                    contentDiv.textContent = 'No content available.';
                }
            } catch (error) {
                console.error('Failed to load log file:', error);
                contentDiv.textContent = 'Error loading log file: ' + error.message;
            }
        }

        // Update char count on input
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('guidance-text');
            if (textarea) {
                textarea.addEventListener('input', updateCharCount);
            }
        });

        // ===== User Management Functions =====

        async function loadUsers() {
            try {
                const response = await fetch(`/api/admin/users?auth=${adminPassword}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load users');
                }

                const usersList = document.getElementById('users-list');

                if (data.users.length === 0) {
                    usersList.innerHTML = '<p style="color: #666;">No users found.</p>';
                    return;
                }

                // Sort users: test users first, then by email
                const sortedUsers = data.users.sort((a, b) => {
                    if (a.is_test_user && !b.is_test_user) return -1;
                    if (!a.is_test_user && b.is_test_user) return 1;
                    return a.email.localeCompare(b.email);
                });

                usersList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #ddd;">
                                <th style="text-align: left; padding: 12px;">Email</th>
                                <th style="text-align: center; padding: 12px;">Test User</th>
                                <th style="text-align: center; padding: 12px;">Subscribed</th>
                                <th style="text-align: center; padding: 12px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedUsers.map(user => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px;">
                                        ${user.email}
                                        ${user.is_test_user ? '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">TEST</span>' : ''}
                                    </td>
                                    <td style="text-align: center; padding: 12px;">
                                        <input type="checkbox" ${user.is_test_user ? 'checked' : ''} 
                                            onchange="toggleUserTest('${user.id}', this.checked)"
                                            style="cursor: pointer;">
                                    </td>
                                    <td style="text-align: center; padding: 12px;">
                                        <input type="checkbox" ${user.subscribed ? 'checked' : ''} 
                                            onchange="toggleUserSubscription('${user.id}', this.checked)"
                                            style="cursor: pointer;">
                                    </td>
                                    <td style="text-align: center; padding: 12px;">
                                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" 
                                            onclick="deleteUser('${user.id}', '${user.email}')">
                                            üóëÔ∏è Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p style="margin-top: 15px; color: #666; font-size: 14px;">
                        Total: ${data.total} users (${sortedUsers.filter(u => u.is_test_user).length} test users)
                    </p>
                `;
            } catch (error) {
                document.getElementById('users-list').innerHTML =
                    `<p style="color: #f44336;">Error loading users: ${error.message}</p>`;
            }
        }

        async function createUser() {
            const emailInput = document.getElementById('new-user-email');
            const testCheckbox = document.getElementById('new-user-test');
            const subscribedCheckbox = document.getElementById('new-user-subscribed');
            const statusDiv = document.getElementById('add-user-status');

            const email = emailInput.value.trim();

            if (!email) {
                showStatus(statusDiv, '‚ö†Ô∏è Please enter an email address', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        email,
                        is_test_user: testCheckbox.checked,
                        subscribed: subscribedCheckbox.checked
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create user');
                }

                showStatus(statusDiv, `‚úì User ${email} created successfully`, 'success');
                emailInput.value = '';

                // Reload users list
                await loadUsers();
            } catch (error) {
                showStatus(statusDiv, `‚úó ${error.message}`, 'error');
            }
        }

        async function toggleUserTest(userId, isTest) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        is_test_user: isTest
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to update user');
                }

                // Reload users to show updated badge
                await loadUsers();
            } catch (error) {
                alert(`Error: ${error.message}`);
                // Reload to revert checkbox state
                await loadUsers();
            }
        }

        async function toggleUserSubscription(userId, subscribed) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        subscribed
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to update user');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
                // Reload to revert checkbox state
                await loadUsers();
            }
        }

        async function deleteUser(userId, email) {
            if (!confirm(`Are you sure you want to delete user ${email}? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to delete user');
                }

                // Reload users list
                await loadUsers();
            } catch (error) {
                alert(`Error deleting user: ${error.message}`);
            }
        }
    </script>
</body>

</html>